"""Config flow for Chore Tracker integration with recurrence wizard."""

from __future__ import annotations

import voluptuous as vol
from datetime import date
from homeassistant import config_entries
from homeassistant.helpers import selector

DOMAIN = "chore_tracker"

CONF_NAME = "name"
CONF_ICON = "icon"
CONF_PERSON_ENTITY = "person_entity"
CONF_RECURRENCE_TYPE = "recurrence_type"
CONF_INTERVAL = "interval"
CONF_DAY_OF_MONTH = "day_of_month"
CONF_MONTH = "month"
CONF_START_DATE = "start_date"


class ChoreTrackerConfigFlow(config_entries.ConfigFlow, domain=DOMAIN):
    VERSION = 1

    def __init__(self):
        self._base_data: dict = {}

    async def async_step_user(self, user_input=None):
        """Page 1: Basic info + recurrence type."""
        if user_input is not None:
            recurrence_type = user_input[CONF_RECURRENCE_TYPE]
            self._base_data = {
                CONF_NAME: user_input[CONF_NAME],
                CONF_ICON: user_input[CONF_ICON],
                CONF_PERSON_ENTITY: user_input.get(CONF_PERSON_ENTITY),
                CONF_RECURRENCE_TYPE: recurrence_type,
            }

            if recurrence_type == "manual":
                # Finish immediately with manual defaults
                data = {
                    **self._base_data,
                    CONF_START_DATE: date.today().isoformat(),
                    "due_days": 9999,
                }
                return self.async_create_entry(title=data[CONF_NAME], data=data)

            # Otherwise go to recurrence details page
            return await self.async_step_recurrence()

        schema = vol.Schema(
            {
                vol.Required(CONF_NAME): str,
                vol.Optional(CONF_ICON, default="mdi:broom"): str,
                vol.Optional(CONF_PERSON_ENTITY): selector.EntitySelector(
                    {"domain": "person"}
                ),
                vol.Required(CONF_RECURRENCE_TYPE, default="daily"): vol.In(
                    ["manual", "daily", "weekly", "monthly", "yearly"]
                ),
            }
        )
        return self.async_show_form(step_id="user", data_schema=schema)

    async def async_step_recurrence(self, user_input=None):
        """Page 2: Recurrence pattern options."""
        if user_input is not None:
            data = {**self._base_data, **user_input}
            return self.async_create_entry(title=data[CONF_NAME], data=data)

        recurrence_type = self._base_data[CONF_RECURRENCE_TYPE]
        schema_dict: dict = {}

        if recurrence_type == "daily":
            schema_dict[vol.Required(CONF_INTERVAL, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "step": 1,
                        "unit_of_measurement": "days",
                        "mode": "box",
                        "translation_key": "occur_every_days",
                    }
                )
            )

        elif recurrence_type == "weekly":
            schema_dict[vol.Required(CONF_INTERVAL, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "step": 1,
                        "unit_of_measurement": "weeks",
                        "mode": "box",
                        "translation_key": "occur_every_weeks",
                    }
                )
            )
            schema_dict[vol.Optional("weekdays", default=[])] = selector.SelectSelector(
                {
                    "options": [
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                        "Sunday",
                    ],
                    "multiple": True,
                }
            )

        elif recurrence_type == "monthly":
            schema_dict[vol.Required(CONF_INTERVAL, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "step": 1,
                        "unit_of_measurement": "months",
                        "mode": "box",
                        "translation_key": "occur_every_months",
                    }
                )
            )
            schema_dict[vol.Required(CONF_DAY_OF_MONTH, default=1)] = int

        elif recurrence_type == "yearly":
            schema_dict[vol.Required(CONF_INTERVAL, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "step": 1,
                        "unit_of_measurement": "years",
                        "mode": "box",
                        "translation_key": "occur_every_years",
                    }
                )
            )
            schema_dict[vol.Required(CONF_MONTH, default=1)] = int
            schema_dict[vol.Required(CONF_DAY_OF_MONTH, default=1)] = int

        # Always put start date last
        schema_dict[vol.Required(CONF_START_DATE, default=date.today().isoformat())] = (
            selector.DateSelector()
        )

        return self.async_show_form(
            step_id="recurrence", data_schema=vol.Schema(schema_dict)
        )

    @staticmethod
    def async_get_options_flow(config_entry: config_entries.ConfigEntry):
        return ChoreTrackerOptionsFlowHandler(config_entry)


class ChoreTrackerOptionsFlowHandler(config_entries.OptionsFlow):
    """Handle editing options after a chore has been created."""

    def __init__(self, entry: config_entries.ConfigEntry) -> None:
        self._entry = entry
        self._base_options: dict = {}

    async def async_step_init(self, user_input=None):
        """Page 1: Basic options."""
        if user_input is not None:
            recurrence_type = user_input[CONF_RECURRENCE_TYPE]
            self._base_options = {
                CONF_RECURRENCE_TYPE: recurrence_type,
                CONF_ICON: user_input.get(CONF_ICON, "mdi:broom"),
                CONF_PERSON_ENTITY: user_input.get(CONF_PERSON_ENTITY),
            }

            if recurrence_type == "manual":
                data = {
                    **self._base_options,
                    CONF_START_DATE: date.today().isoformat(),
                    "due_days": 9999,
                }
                return self.async_create_entry(title="", data=data)

            return await self.async_step_recurrence()

        options = self._entry.options or {}
        schema = vol.Schema(
            {
                vol.Required(
                    CONF_RECURRENCE_TYPE,
                    default=options.get(CONF_RECURRENCE_TYPE, "daily"),
                ): vol.In(["manual", "daily", "weekly", "monthly", "yearly"]),
                vol.Optional(
                    CONF_ICON, default=options.get(CONF_ICON, "mdi:broom")
                ): str,
                vol.Optional(
                    CONF_PERSON_ENTITY, default=options.get(CONF_PERSON_ENTITY)
                ): selector.EntitySelector({"domain": "person"}),
            }
        )
        return self.async_show_form(step_id="init", data_schema=schema)

    async def async_step_recurrence(self, user_input=None):
        """Page 2: Recurrence pattern options."""
        if user_input is not None:
            data = {**self._base_data, **user_input}
            return self.async_create_entry(title=data[CONF_NAME], data=data)

        recurrence_type = self._base_data[CONF_RECURRENCE_TYPE]
        schema_dict: dict = {}

        if recurrence_type == "daily":
            schema_dict[vol.Required(CONF_INTERVAL, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "step": 1,
                        "unit_of_measurement": "days",
                        "mode": "box",
                        "translation_key": "occur_every_days",
                    }
                )
            )

        elif recurrence_type == "weekly":
            schema_dict[vol.Required(CONF_INTERVAL, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "step": 1,
                        "unit_of_measurement": "weeks",
                        "mode": "box",
                        "translation_key": "occur_every_weeks",
                    }
                )
            )
            schema_dict[vol.Optional("weekdays", default=[])] = selector.SelectSelector(
                {
                    "options": [
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                        "Sunday",
                    ],
                    "multiple": True,
                }
            )

        elif recurrence_type == "monthly":
            schema_dict[vol.Required(CONF_INTERVAL, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "step": 1,
                        "unit_of_measurement": "months",
                        "mode": "box",
                        "translation_key": "occur_every_months",
                    }
                )
            )
            schema_dict[vol.Required(CONF_DAY_OF_MONTH, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "max": 31,
                        "mode": "box",
                        "translation_key": "day_of_month",
                    }
                )
            )

        elif recurrence_type == "yearly":
            schema_dict[vol.Required(CONF_INTERVAL, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "step": 1,
                        "unit_of_measurement": "years",
                        "mode": "box",
                        "translation_key": "occur_every_years",
                    }
                )
            )
            schema_dict[vol.Required(CONF_MONTH, default=1)] = selector.SelectSelector(
                {
                    "options": [
                        "January",
                        "February",
                        "March",
                        "April",
                        "May",
                        "June",
                        "July",
                        "August",
                        "September",
                        "October",
                        "November",
                        "December",
                    ],
                }
            )
            schema_dict[vol.Required(CONF_DAY_OF_MONTH, default=1)] = (
                selector.NumberSelector(
                    {
                        "min": 1,
                        "max": 31,
                        "mode": "box",
                        "translation_key": "day_of_month",
                    }
                )
            )

        # Always put start date last
        schema_dict[vol.Required(CONF_START_DATE, default=date.today().isoformat())] = (
            selector.DateSelector()
        )

        return self.async_show_form(
            step_id="recurrence", data_schema=vol.Schema(schema_dict)
        )
